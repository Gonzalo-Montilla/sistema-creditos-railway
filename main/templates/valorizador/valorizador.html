{% extends "base.html" %}

{% block title %}Valorizador de Créditos{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .resultado-card {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-left: 4px solid #28a745;
    }
    
    .comparacion-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .comparacion-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .resultado-valor {
        font-size: 1.25rem;
        font-weight: bold;
        color: #28a745;
    }
    
    .loading {
        opacity: 0.6;
        pointer-events: none;
    }
    
    .modalidad-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        background-color: #28a745;
        color: white;
        border-radius: 20px;
        text-decoration: none;
        transition: background-color 0.2s;
    }
    
    .modalidad-badge.active {
        background-color: #dc3545;
    }
    
        .modalidad-badge:hover {
            background-color: #218838;
            color: white;
            text-decoration: none;
        }
        
        /* Placeholder ligeramente transparente */
        .placeholder-transparent::placeholder {
            color: rgba(108, 117, 125, 0.6) !important;
            opacity: 0.7;
        }
        
        .placeholder-transparent::-webkit-input-placeholder {
            color: rgba(108, 117, 125, 0.6) !important;
            opacity: 0.7;
        }
        
        .placeholder-transparent::-moz-placeholder {
            color: rgba(108, 117, 125, 0.6) !important;
            opacity: 0.7;
        }
        
        .placeholder-transparent:-ms-input-placeholder {
            color: rgba(108, 117, 125, 0.6) !important;
            opacity: 0.7;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-calculator"></i> Valorizador de Créditos</h1>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Panel de cálculo -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog"></i> Parámetros del Crédito</h5>
                </div>
                <div class="card-body">
                    <form id="calculadoraForm">
                        <div class="mb-3">
                            <label class="form-label">Monto del Crédito</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control placeholder-transparent" id="monto" 
                                       placeholder="Ej: 1000000" min="50000" step="50000" required>
                            </div>
                            <small class="form-text text-muted">Ingrese el capital a prestar</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tasa de Interés Mensual</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="tasa_mensual" 
                                       value="20" min="0" max="50" step="0.5" required>
                                <span class="input-group-text">%</span>
                            </div>
                            <small class="form-text text-muted">Porcentaje mensual (ej: 20%)</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Modalidad de Pago</label>
                            <select class="form-select" id="tipo_plazo" required>
                                <option value="DIARIO">Diario</option>
                                <option value="SEMANAL">Semanal</option>
                                <option value="QUINCENAL">Quincenal</option>
                                <option value="MENSUAL">Mensual</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Cantidad de Cuotas</label>
                            <input type="number" class="form-control" id="cantidad_cuotas" 
                                   value="30" min="1" max="365" required>
                            <small class="form-text text-muted" id="tiempo_equivalente">≈ 1.0 mes</small>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100" id="btnCalcular">
                            <i class="fas fa-calculator"></i> Calcular Crédito
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Panel de resultados -->
        <div class="col-lg-8">
            <div id="resultadosContainer" style="display: none;">
                <!-- Resultado individual -->
                <div class="card shadow-sm resultado-card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Resultado del Cálculo</h5>
                    </div>
                    <div class="card-body">
                        <div id="resultadoIndividual">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="cronogramaContainer" style="display: none;" class="mt-4">
                <!-- Cronograma de pagos -->
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Cronograma de Pagos</h5>
                    </div>
                    <div class="card-body">
                        <div id="cronogramaResultados">
                            <!-- Se llena dinámicamente -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Estado inicial -->
            <div id="estadoInicial" class="text-center py-5">
                <i class="fas fa-calculator fa-5x text-muted mb-3"></i>
                <h4 class="text-muted">Valorizador de Créditos</h4>
                <p class="text-muted">Ingrese los parámetros del crédito para ver el cálculo</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal de carga -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Calculando...</span>
                </div>
                <div class="mt-3">Calculando...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let loadingModal;

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
        backdrop: 'static',
        keyboard: false
    });
    
    // Asegurar que el modal se oculte completamente
    document.getElementById('loadingModal').addEventListener('hidden.bs.modal', function () {
        // Modal completamente oculto
        console.log('Modal cerrado');
    });
    
    // Actualizar tiempo equivalente cuando cambie la modalidad o cuotas
    document.getElementById('tipo_plazo').addEventListener('change', actualizarTiempoEquivalente);
    document.getElementById('cantidad_cuotas').addEventListener('input', actualizarTiempoEquivalente);
    
    // Form submit
    document.getElementById('calculadoraForm').addEventListener('submit', function(e) {
        e.preventDefault();
        calcularCredito();
    });
    
    
    actualizarTiempoEquivalente();
});

function actualizarTiempoEquivalente() {
    const tipoPlazo = document.getElementById('tipo_plazo').value;
    const cuotas = parseInt(document.getElementById('cantidad_cuotas').value) || 0;
    
    let meses = 0;
    switch(tipoPlazo) {
        case 'DIARIO':
            meses = cuotas / 30;
            break;
        case 'SEMANAL':
            meses = cuotas / 4.33;
            break;
        case 'QUINCENAL':
            meses = cuotas / 2;
            break;
        case 'MENSUAL':
            meses = cuotas;
            break;
    }
    
    document.getElementById('tiempo_equivalente').textContent = `≈ ${meses.toFixed(1)} mes${meses !== 1 ? 'es' : ''}`;
}


async function calcularCredito() {
    const datos = {
        monto: parseFloat(document.getElementById('monto').value),
        tasa_mensual: parseFloat(document.getElementById('tasa_mensual').value),
        cantidad_cuotas: parseInt(document.getElementById('cantidad_cuotas').value),
        tipo_plazo: document.getElementById('tipo_plazo').value
    };
    
    // Validaciones
    if (!datos.monto || datos.monto <= 0) {
        alert('Ingrese un monto válido');
        return;
    }
    
    if (!datos.tasa_mensual || datos.tasa_mensual < 0) {
        alert('Ingrese una tasa válida');
        return;
    }
    
    if (!datos.cantidad_cuotas || datos.cantidad_cuotas <= 0) {
        alert('Ingrese una cantidad de cuotas válida');
        return;
    }
    
    try {
        loadingModal.show();
        
        const response = await fetch('/valorizador/calcular/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(datos)
        });
        
        const result = await response.json();
        
        if (result.success) {
            mostrarResultado(result.resultado);
            generarCronograma(result.resultado);
            document.getElementById('cronogramaContainer').style.display = 'block';
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión');
    } finally {
        // Cerrar modal de forma simple y directa
        setTimeout(() => {
            try {
                // Ocultar el modal de Bootstrap
                if (loadingModal) {
                    loadingModal.hide();
                }
                
                // Forzar limpieza completa después de un momento
                setTimeout(() => {
                    const modalElement = document.getElementById('loadingModal');
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    
                    // Limpiar modal
                    if (modalElement) {
                        modalElement.style.display = 'none';
                        modalElement.classList.remove('show');
                        modalElement.setAttribute('aria-hidden', 'true');
                        modalElement.removeAttribute('aria-modal');
                        modalElement.removeAttribute('role');
                    }
                    
                    // Limpiar todos los backdrops
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Limpiar estado del body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                    document.body.removeAttribute('data-bs-overflow');
                    document.body.removeAttribute('data-bs-padding-right');
                }, 100);
                
            } catch (error) {
                console.error('Error cerrando modal:', error);
                // Limpieza de emergencia
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
            }
        }, 200); // Dar tiempo a que se complete la respuesta
    }
}


function mostrarResultado(resultado) {
    const html = `
        <div class="row">
            <div class="col-md-6">
                <h6 class="text-success">📋 Resumen del Crédito</h6>
                <p class="mb-1">Crédito de $${resultado.calculos.capital.toLocaleString('es-CO')} por ${resultado.calculos.tiempo_meses.toFixed(1)} meses</p>
                <p class="mb-1"><strong>${resultado.resumen.modalidad}</strong></p>
                <p class="mb-3 text-success">Total a pagar: $${resultado.calculos.monto_total.toLocaleString('es-CO')}</p>
            </div>
            <div class="col-md-6">
                <h6 class="text-info">📊 Detalles del Cálculo</h6>
                <table class="table table-sm">
                    <tr>
                        <td><strong>Capital:</strong></td>
                        <td class="text-end">$${resultado.calculos.capital.toLocaleString('es-CO')}</td>
                    </tr>
                    <tr>
                        <td><strong>Tiempo:</strong></td>
                        <td class="text-end">${resultado.calculos.tiempo_meses.toFixed(1)} meses</td>
                    </tr>
                    <tr>
                        <td><strong>Intereses:</strong></td>
                        <td class="text-end">$${resultado.calculos.interes_total.toLocaleString('es-CO')}</td>
                    </tr>
                    <tr class="table-success">
                        <td><strong>Cuota ${resultado.parametros.periodo_texto}:</strong></td>
                        <td class="text-end resultado-valor">$${resultado.calculos.valor_cuota.toLocaleString('es-CO')}</td>
                    </tr>
                </table>
            </div>
        </div>
    `;
    
    document.getElementById('resultadoIndividual').innerHTML = html;
    document.getElementById('resultadosContainer').style.display = 'block';
    document.getElementById('estadoInicial').style.display = 'none';
}

function generarCronograma(resultado) {
    const parametros = resultado.parametros;
    const calculos = resultado.calculos;
    const cronograma = resultado.cronograma;
    
    // Generar HTML del cronograma
    const fechaHoy = new Date().toLocaleDateString('es-CO');
    let html = `
        <div class="mb-3">
            <h6>Cronograma para ${parametros.cantidad_cuotas} cuotas ${parametros.periodo_texto} de $${calculos.valor_cuota.toLocaleString('es-CO')}</h6>
            <small class="text-muted">Fechas calculadas desde hoy (${fechaHoy})</small>
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover">
                <thead class="table-success sticky-top">
                    <tr>
                        <th>Cuota</th>
                        <th>Fecha Vencimiento</th>
                        <th class="text-end">Monto</th>
                        <th>Día Semana</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Asegurar que cronograma existe y tiene elementos
    if (cronograma && cronograma.length > 0) {
        cronograma.forEach(cuota => {
            // Resaltar fines de semana usando el dato del backend
            const claseRow = cuota.es_fin_semana ? 'table-warning' : '';
            
            html += `
                <tr class="${claseRow}">
                    <td><strong>#${cuota.numero_cuota}</strong></td>
                    <td>${cuota.fecha_formateada}</td>
                    <td class="text-end"><strong>$${calculos.valor_cuota.toLocaleString('es-CO')}</strong></td>
                    <td><small class="text-muted">${cuota.dia_semana}</small></td>
                </tr>
            `;
        });
    } else {
        // Fallback si no hay cronograma
        html += `
            <tr>
                <td colspan="4" class="text-center text-muted">No se pudo generar el cronograma</td>
            </tr>
        `;
    }
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div class="mt-3 p-3 bg-light rounded">
            <div class="row text-center">
                <div class="col-4">
                    <strong class="text-success">${parametros.cantidad_cuotas}</strong><br>
                    <small class="text-muted">Total Cuotas</small>
                </div>
                <div class="col-4">
                    <strong class="text-primary">$${calculos.valor_cuota.toLocaleString('es-CO')}</strong><br>
                    <small class="text-muted">Por Cuota</small>
                </div>
                <div class="col-4">
                    <strong class="text-danger">$${calculos.monto_total.toLocaleString('es-CO')}</strong><br>
                    <small class="text-muted">Total a Pagar</small>
                </div>
            </div>
        </div>
        
        ${(cronograma && cronograma.some(c => c.es_fin_semana)) ? '<div class="alert alert-warning mt-2 py-2"><small><i class="fas fa-exclamation-triangle"></i> Las cuotas marcadas caen en fin de semana</small></div>' : ''}
    `;
    
    document.getElementById('cronogramaResultados').innerHTML = html;
}

// Función para obtener CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}