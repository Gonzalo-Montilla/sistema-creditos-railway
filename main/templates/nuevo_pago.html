{% extends 'base.html' %}

{% block title %}Registrar Pago - Sistema de Créditos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="page-title mb-0">
        <i class="fas fa-money-check"></i> Registrar Pago
    </h1>
    <a href="{% url 'pagos' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver
    </a>
</div>

<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0">
            <i class="fas fa-money-check-alt"></i> Formulario de Registro de Pago
        </h6>
    </div>
    <div class="card-body">
        {% if not creditos_info %}
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>No hay créditos disponibles para recibir pagos.</strong><br>
            Todos los créditos están pagados o no están en estado APROBADO/DESEMBOLSADO.
        </div>
        {% endif %}
        
        <form method="post">
            {% csrf_token %}
            {{ form.cliente_encontrado }}
            
            <!-- Búsqueda por cédula -->
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.cedula_cliente.id_for_label }}" class="form-label">
                            <i class="fas fa-id-card"></i> {{ form.cedula_cliente.label }} *
                        </label>
                        <div class="input-group">
                            {{ form.cedula_cliente }}
                            <button class="btn btn-outline-primary" type="button" id="buscar-cliente-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        {% if form.cedula_cliente.errors %}
                            <div class="text-danger">{{ form.cedula_cliente.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Busque al cliente por su número de cédula</small>
                    </div>
                </div>
            </div>
            
            <!-- Información del cliente encontrado -->
            <div id="cliente-info" style="display: none;" class="mb-4">
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-user-check"></i> Cliente Encontrado
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-2 text-center">
                                <img id="cliente-foto" src="" alt="Foto del cliente" class="img-thumbnail rounded-circle" style="width: 80px; height: 80px; object-fit: cover; display: none;">
                                <div id="sin-foto" class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 80px; height: 80px; margin: 0 auto;">
                                    <i class="fas fa-user fa-2x text-muted"></i>
                                </div>
                            </div>
                            <div class="col-md-10">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Nombre:</strong> <span id="cliente-nombre"></span></p>
                                        <p class="mb-2"><strong>Cédula:</strong> <span id="cliente-cedula"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Celular:</strong> <span id="cliente-celular"></span></p>
                                        <p class="mb-2"><strong>Dirección:</strong> <span id="cliente-direccion"></span></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.credito.id_for_label }}" class="form-label">
                            <i class="fas fa-credit-card"></i> Crédito *
                        </label>
                        {{ form.credito }}
                        {% if form.credito.errors %}
                            <div class="text-danger">{{ form.credito.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Primero busque al cliente por cédula</small>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.monto.id_for_label }}" class="form-label">
                            <i class="fas fa-dollar-sign"></i> Monto del Pago *
                            <span id="monto-auto-label" class="badge bg-success ms-2" style="display: none;">Auto-llenado</span>
                        </label>
                        <div class="input-group">
                            {{ form.monto }}
                            <button class="btn btn-outline-secondary" type="button" id="editar-monto-btn" style="display: none;" title="Editar monto">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                        {% if form.monto.errors %}
                            <div class="text-danger">{{ form.monto.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted" id="monto-help">El monto se llenará automáticamente al seleccionar un crédito</small>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="{{ form.numero_cuota.id_for_label }}" class="form-label">
                            <i class="fas fa-hashtag"></i> Número de Cuota *
                            <span id="cuota-auto-label" class="badge bg-success ms-2" style="display: none;">Auto-calculado</span>
                        </label>
                        {{ form.numero_cuota }}
                        {% if form.numero_cuota.errors %}
                            <div class="text-danger">{{ form.numero_cuota.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted" id="cuota-help">Se calculará automáticamente la siguiente cuota a pagar</small>
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label for="{{ form.observaciones.id_for_label }}" class="form-label">
                    <i class="fas fa-sticky-note"></i> Observaciones
                </label>
                {{ form.observaciones }}
                {% if form.observaciones.errors %}
                    <div class="text-danger">{{ form.observaciones.errors }}</div>
                {% endif %}
            </div>
            
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <a href="{% url 'pagos' %}" class="btn btn-secondary me-md-2">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-primary" {% if not creditos_info %}disabled{% endif %}>
                    <i class="fas fa-save"></i> Registrar Pago
                </button>
            </div>
        </form>
    </div>
</div>

{% if creditos_info %}
<div class="card">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0">
            <i class="fas fa-info-circle"></i> Créditos Disponibles para Pago
        </h6>
    </div>
    <div class="card-body">
        <div class="alert alert-info" role="alert">
            <i class="fas fa-lightbulb"></i>
            <strong>Información de referencia:</strong> Estos son todos los créditos que pueden recibir pagos actualmente.
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Crédito #</th>
                        <th>Cliente</th>
                        <th>Monto Total</th>
                        <th>Ya Pagado</th>
                        <th>Saldo Pendiente</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody>
                    {% for credito in creditos_info %}
                    <tr>
                        <td><strong class="text-primary">#{{ credito.id|stringformat:"04d" }}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary rounded-pill me-2">
                                    {{ credito.cliente|slice:":2"|upper }}
                                </span>
                                {{ credito.cliente }}
                            </div>
                        </td>
                        <td class="text-primary"><strong>${{ credito.monto_total|floatformat:0 }}</strong></td>
                        <td class="text-success"><strong>${{ credito.total_pagado|floatformat:0 }}</strong></td>
                        <td class="text-warning"><strong>${{ credito.saldo_pendiente|floatformat:0 }}</strong></td>
                        <td>
                            <span class="badge bg-success">Activo</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="mt-3 p-2 bg-light rounded">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i>
                <strong>Nota:</strong> Solo se muestran los créditos en estado "APROBADO" o "DESEMBOLSADO" que pueden recibir pagos.
            </small>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let clienteEncontrado = null;
let creditosDisponibles = [];

// Función para buscar cliente por cédula
function buscarCliente() {
    const cedula = document.getElementById('cedula_cliente_pago').value.trim();
    const btn = document.getElementById('buscar-cliente-btn');
    
    if (!cedula) {
        alert('Por favor ingrese una cédula');
        return;
    }
    
    // Mostrar loading
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    // Ocultar información previa
    document.getElementById('cliente-info').style.display = 'none';
    
    // Realizar búsqueda AJAX
    fetch(`/buscar-creditos-cliente/?cedula=${encodeURIComponent(cedula)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                clienteEncontrado = data.cliente;
                creditosDisponibles = data.creditos;
                mostrarClienteEncontrado(data.cliente);
                llenarCreditosSelect(data.creditos);
            } else {
                alert('Error: ' + data.error);
                limpiarFormulario();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error de conexión al buscar cliente');
            limpiarFormulario();
        })
        .finally(() => {
            // Restaurar botón
            btn.innerHTML = '<i class="fas fa-search"></i>';
            btn.disabled = false;
        });
}

// Función para mostrar información del cliente encontrado
function mostrarClienteEncontrado(cliente) {
    document.getElementById('cliente-nombre').textContent = cliente.nombre_completo;
    document.getElementById('cliente-cedula').textContent = cliente.cedula;
    document.getElementById('cliente-celular').textContent = cliente.celular;
    document.getElementById('cliente-direccion').textContent = cliente.direccion;
    
    // Manejar foto
    const fotoImg = document.getElementById('cliente-foto');
    const sinFoto = document.getElementById('sin-foto');
    
    if (cliente.foto_url) {
        fotoImg.src = cliente.foto_url;
        fotoImg.style.display = 'block';
        sinFoto.style.display = 'none';
    } else {
        fotoImg.style.display = 'none';
        sinFoto.style.display = 'flex';
    }
    
    // Mostrar card de información
    document.getElementById('cliente-info').style.display = 'block';
}

// Función para llenar el select de créditos
function llenarCreditosSelect(creditos) {
    const select = document.getElementById('credito_select');
    
    // Limpiar options existentes
    select.innerHTML = '<option value="">Seleccione un crédito</option>';
    
    // Agregar créditos disponibles
    creditos.forEach(credito => {
        const option = document.createElement('option');
        option.value = credito.id;
        option.textContent = `Crédito #${String(credito.id).padStart(4, '0')} - Saldo: $${credito.saldo_pendiente.toLocaleString()} (${credito.tipo_plazo} - ${credito.cantidad_cuotas} cuotas)`;
        select.appendChild(option);
    });
    
    // Habilitar select
    select.disabled = false;
    
    // Agregar event listener para cuando se seleccione un crédito
    select.addEventListener('change', function() {
        const creditoId = this.value;
        if (creditoId) {
            const creditoSeleccionado = creditosDisponibles.find(c => c.id == creditoId);
            if (creditoSeleccionado) {
                llenarInformacionCuota(creditoSeleccionado);
            }
        } else {
            limpiarInformacionCuota();
        }
    });
}

// Función para llenar información de la cuota automáticamente
function llenarInformacionCuota(credito) {
    // Llenar monto con el valor de la cuota
    const montoInput = document.getElementById('id_monto');
    if (montoInput) {
        montoInput.value = credito.valor_cuota.toFixed(2);
        montoInput.style.backgroundColor = '#e7f3ff'; // Azul claro para indicar auto-llenado
    }
    
    // Calcular la siguiente cuota a pagar
    const cuotasPagadas = Math.round(credito.total_pagado / credito.valor_cuota);
    const siguienteCuota = cuotasPagadas + 1;
    
    // Llenar número de cuota
    const cuotaInput = document.getElementById('id_numero_cuota');
    if (cuotaInput) {
        cuotaInput.value = Math.min(siguienteCuota, credito.cantidad_cuotas);
        cuotaInput.style.backgroundColor = '#e7f3ff'; // Azul claro para indicar auto-llenado
    }
    
    // Mostrar etiquetas de auto-llenado
    const montoLabel = document.getElementById('monto-auto-label');
    const cuotaLabel = document.getElementById('cuota-auto-label');
    const editarBtn = document.getElementById('editar-monto-btn');
    
    if (montoLabel) montoLabel.style.display = 'inline';
    if (cuotaLabel) cuotaLabel.style.display = 'inline';
    if (editarBtn) editarBtn.style.display = 'inline-block';
    
    // Actualizar textos de ayuda
    const montoHelp = document.getElementById('monto-help');
    const cuotaHelp = document.getElementById('cuota-help');
    
    if (montoHelp) {
        montoHelp.innerHTML = '<i class="fas fa-check-circle text-success"></i> Monto auto-llenado con el valor de la cuota';
    }
    if (cuotaHelp) {
        cuotaHelp.innerHTML = `<i class="fas fa-check-circle text-success"></i> Siguiente cuota calculada: #${siguienteCuota}`;
    }
    
    // Mostrar información adicional del crédito
    mostrarInformacionCredito(credito, siguienteCuota);
}

// Función para mostrar información adicional del crédito seleccionado
function mostrarInformacionCredito(credito, siguienteCuota) {
    // Crear o actualizar card de información del crédito
    let creditoInfoDiv = document.getElementById('credito-info');
    
    if (!creditoInfoDiv) {
        // Crear el div si no existe
        creditoInfoDiv = document.createElement('div');
        creditoInfoDiv.id = 'credito-info';
        creditoInfoDiv.className = 'mb-4';
        
        // Insertar después del campo de crédito
        const creditoField = document.getElementById('credito_select').closest('.mb-3');
        creditoField.parentNode.insertBefore(creditoInfoDiv, creditoField.nextSibling);
    }
    
    const cuotasPagadas = Math.round(credito.total_pagado / credito.valor_cuota);
    const progreso = (cuotasPagadas / credito.cantidad_cuotas) * 100;
    
    creditoInfoDiv.innerHTML = `
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle"></i> Información del Crédito Seleccionado
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Crédito N°:</strong> #${String(credito.id).padStart(4, '0')}</p>
                        <p class="mb-2"><strong>Monto Total:</strong> <span class="text-primary">$${credito.monto_total.toLocaleString()}</span></p>
                        <p class="mb-2"><strong>Ya Pagado:</strong> <span class="text-success">$${credito.total_pagado.toLocaleString()}</span></p>
                        <p class="mb-2"><strong>Saldo Pendiente:</strong> <span class="text-warning">$${credito.saldo_pendiente.toLocaleString()}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Modalidad:</strong> ${credito.tipo_plazo}</p>
                        <p class="mb-2"><strong>Valor Cuota:</strong> <span class="text-info">$${credito.valor_cuota.toLocaleString()}</span></p>
                        <p class="mb-2"><strong>Cuotas Pagadas:</strong> ${cuotasPagadas} de ${credito.cantidad_cuotas}</p>
                        <p class="mb-2"><strong>Siguiente Cuota:</strong> <span class="badge bg-primary">#${siguienteCuota}</span></p>
                    </div>
                </div>
                
                <!-- Barra de progreso -->
                <div class="mt-3">
                    <label class="form-label small text-muted">Progreso del Pago:</label>
                    <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${progreso}%" aria-valuenow="${progreso}" aria-valuemin="0" aria-valuemax="100">
                            ${progreso.toFixed(1)}%
                        </div>
                    </div>
                    <small class="text-muted">Cuotas pagadas: ${cuotasPagadas}/${credito.cantidad_cuotas}</small>
                </div>
                
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-lightbulb"></i>
                    <strong>Sugerencia:</strong> El valor de la cuota (${credito.valor_cuota.toLocaleString()}) ha sido llenado automáticamente. 
                    Puede modificarlo si es necesario.
                </div>
            </div>
        </div>
    `;
    
    creditoInfoDiv.style.display = 'block';
}

// Función para limpiar información de la cuota
function limpiarInformacionCuota() {
    // Limpiar campos
    const montoInput = document.getElementById('id_monto');
    const cuotaInput = document.getElementById('id_numero_cuota');
    
    if (montoInput) {
        montoInput.value = '';
        montoInput.style.backgroundColor = ''; // Restaurar color original
    }
    if (cuotaInput) {
        cuotaInput.value = '';
        cuotaInput.style.backgroundColor = ''; // Restaurar color original
    }
    
    // Ocultar etiquetas de auto-llenado
    const montoLabel = document.getElementById('monto-auto-label');
    const cuotaLabel = document.getElementById('cuota-auto-label');
    const editarBtn = document.getElementById('editar-monto-btn');
    
    if (montoLabel) montoLabel.style.display = 'none';
    if (cuotaLabel) cuotaLabel.style.display = 'none';
    if (editarBtn) editarBtn.style.display = 'none';
    
    // Restaurar textos de ayuda originales
    const montoHelp = document.getElementById('monto-help');
    const cuotaHelp = document.getElementById('cuota-help');
    
    if (montoHelp) {
        montoHelp.innerHTML = 'El monto se llenará automáticamente al seleccionar un crédito';
    }
    if (cuotaHelp) {
        cuotaHelp.innerHTML = 'Se calculará automáticamente la siguiente cuota a pagar';
    }
    
    // Ocultar información del crédito
    const creditoInfoDiv = document.getElementById('credito-info');
    if (creditoInfoDiv) {
        creditoInfoDiv.style.display = 'none';
    }
}

// Función para limpiar formulario
function limpiarFormulario() {
    document.getElementById('cliente-info').style.display = 'none';
    const select = document.getElementById('credito_select');
    select.innerHTML = '<option value="">Primero busque al cliente</option>';
    select.disabled = true;
    clienteEncontrado = null;
    creditosDisponibles = [];
    limpiarInformacionCuota();
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // Botón buscar
    document.getElementById('buscar-cliente-btn').addEventListener('click', buscarCliente);
    
    // Enter en campo de cédula
    document.getElementById('cedula_cliente_pago').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarCliente();
        }
    });
    
    // Limpiar cuando se cambie la cédula
    document.getElementById('cedula_cliente_pago').addEventListener('input', function() {
        if (clienteEncontrado) {
            limpiarFormulario();
        }
    });
    
    // Botón para editar monto manualmente
    document.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'editar-monto-btn') {
            const montoInput = document.getElementById('id_monto');
            if (montoInput) {
                montoInput.style.backgroundColor = '#fff3cd'; // Amarillo para indicar edición manual
                montoInput.focus();
                montoInput.select();
                
                // Cambiar el texto de ayuda
                const montoHelp = document.getElementById('monto-help');
                if (montoHelp) {
                    montoHelp.innerHTML = '<i class="fas fa-edit text-warning"></i> Monto editado manualmente. Asegúrese de que sea correcto.';
                }
            }
        }
    });
});
</script>
{% endblock %}
