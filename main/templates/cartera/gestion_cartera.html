{% extends 'base.html' %}

{% block title %}Gestión de Cartera{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-wallet2"></i> Gestión de Cartera</h2>
    <div>
        <a href="{% url 'cartera_vencida' %}" class="btn btn-outline-danger me-2">
            <i class="bi bi-exclamation-triangle"></i> Cartera Vencida
        </a>
        <form method="post" action="{% url 'actualizar_cartera' %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" onclick="return confirm('¿Está seguro de actualizar el estado de cartera?')">
                <i class="bi bi-arrow-clockwise"></i> Actualizar Cartera
            </button>
        </form>
    </div>
</div>

<!-- Métricas principales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card border-0 bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ analisis_hoy.cartera_total|floatformat:0 }}</h4>
                        <p class="card-text">Cartera Total</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-wallet2" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ analisis_hoy.cartera_al_dia|floatformat:0 }}</h4>
                        <p class="card-text">Cartera al Día</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-danger text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">${{ analisis_hoy.cartera_vencida|floatformat:0 }}</h4>
                        <p class="card-text">Cartera Vencida</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card border-0 bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ analisis_hoy.porcentaje_cartera_vencida|floatformat:1 }}%</h4>
                        <p class="card-text">% Cartera Vencida</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-graph-down" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Estados de mora y gráficos -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Estados de Mora</h5>
            </div>
            <div class="card-body">
                <!-- Canvas para gráfico de dona -->
                <div class="text-center mb-3">
                    <canvas id="graficoEstadosMora" width="300" height="300"></canvas>
                </div>
                
                <!-- Datos numéricos debajo del gráfico -->
                <div class="row">
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <span class="badge bg-success">{{ analisis_hoy.creditos_al_dia }}</span>
                            <small class="d-block">Al Día</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center mb-2">
                            <span class="badge bg-warning">{{ analisis_hoy.creditos_mora_temprana }}</span>
                            <small class="d-block">Mora Temprana</small>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <span class="badge bg-danger">{{ analisis_hoy.creditos_mora_alta }}</span>
                            <small class="d-block">Mora Alta</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <span class="badge bg-dark">{{ analisis_hoy.creditos_mora_critica }}</span>
                            <small class="d-block">Mora Crítica</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Evolución de Cartera (Últimos 7 días)</h5>
            </div>
            <div class="card-body">
                <canvas id="graficoEvolucionCartera" width="400" height="200"></canvas>
                
                <!-- Métricas del día en formato compacto -->
                <div class="row mt-3 pt-2 border-top">
                    <div class="col-6">
                        <small class="text-muted">Pagos Hoy</small>
                        <div class="fw-bold">${{ analisis_hoy.pagos_del_dia|floatformat:0 }}</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Meta Diaria</small>
                        <div class="fw-bold">${{ analisis_hoy.meta_cobranza_diaria|floatformat:0 }}</div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <small class="text-muted">Cumplimiento</small>
                        <div class="fw-bold {% if analisis_hoy.porcentaje_cumplimiento_meta >= 100 %}text-success{% else %}text-warning{% endif %}">{{ analisis_hoy.porcentaje_cumplimiento_meta|floatformat:1 }}%</div>
                    </div>
                    <div class="col-6">
                        <small class="text-muted">Mora Promedio</small>
                        <div class="fw-bold">{{ analisis_hoy.dias_mora_promedio|floatformat:1 }} días</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Créditos más críticos -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-exclamation-circle"></i> 
                    Créditos Más Críticos (Top 10)
                </h5>
            </div>
            <div class="card-body">
                {% if creditos_criticos %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Cliente</th>
                                <th>Crédito</th>
                                <th>Saldo</th>
                                <th>Días Mora</th>
                                <th>Estado</th>
                                <th>Interés Moratorio</th>
                                <th>Cobrador</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for credito in creditos_criticos %}
                            <tr>
                                <td>
                                    <strong>{{ credito.cliente.nombre_completo }}</strong>
                                    <br><small class="text-muted">{{ credito.cliente.cedula }}</small>
                                </td>
                                <td>
                                    #{{ credito.id }}
                                    <br><small class="text-muted">${{ credito.monto|floatformat:0 }}</small>
                                </td>
                                <td>
                                    <strong>${{ credito.saldo_pendiente|floatformat:0 }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-{{ credito.get_color_mora }}">
                                        {{ credito.dias_mora }} días
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-{{ credito.get_color_mora }}">
                                        {{ credito.get_estado_mora_display }}
                                    </span>
                                </td>
                                <td>
                                    <strong class="text-danger">${{ credito.interes_moratorio|floatformat:0 }}</strong>
                                </td>
                                <td>
                                    {% if credito.cobrador %}
                                        <small>{{ credito.cobrador.nombre_completo }}</small>
                                    {% else %}
                                        <small class="text-muted">Sin asignar</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'detalle_cliente' credito.cliente.id %}" 
                                           class="btn btn-sm btn-outline-primary" 
                                           title="Ver cliente">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{% url 'nuevo_pago' %}?credito={{ credito.id }}" 
                                           class="btn btn-sm btn-outline-success" 
                                           title="Registrar pago">
                                            <i class="bi bi-cash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    <h4 class="text-success mt-3">¡Excelente!</h4>
                    <p class="text-muted">No hay créditos en mora crítica en este momento.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enlaces rápidos -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card border-info">
            <div class="card-body text-center">
                <i class="bi bi-graph-up" style="font-size: 2rem; color: #0dcaf0;"></i>
                <h5 class="card-title mt-2">KPIs por Cobrador</h5>
                <p class="card-text">Análisis detallado de rendimiento y efectividad</p>
                <a href="{% url 'kpis_cobradores' %}" class="btn btn-outline-info">
                    <i class="bi bi-graph-up"></i> Ver KPIs
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-body text-center">
                <i class="bi bi-bell" style="font-size: 2rem; color: #ffc107;"></i>
                <h5 class="card-title mt-2">Alertas Automáticas</h5>
                <p class="card-text">Notificaciones de vencimientos y mora</p>
                <a href="#" class="btn btn-outline-warning">
                    <i class="bi bi-arrow-right"></i> Próximamente
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-success">
            <div class="card-body text-center">
                <i class="bi bi-file-earmark-excel" style="font-size: 2rem; color: #198754;"></i>
                <h5 class="card-title mt-2">Exportar Datos</h5>
                <p class="card-text">Descargar reportes en Excel y PDF</p>
                <a href="#" class="btn btn-outline-success">
                    <i class="bi bi-arrow-right"></i> Próximamente
                </a>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
/* Estilos para los gráficos */
.chart-container {
    position: relative;
    height: 300px;
    width: 100%;
}

#graficoEstadosMora {
    max-height: 250px;
}

#graficoEvolucionCartera {
    max-height: 200px;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Datos para los gráficos
const datosEstadosMora = {
    alDia: {{ analisis_hoy.creditos_al_dia }},
    moraTemp: {{ analisis_hoy.creditos_mora_temprana }},
    moraAlta: {{ analisis_hoy.creditos_mora_alta }},
    moraCritica: {{ analisis_hoy.creditos_mora_critica }}
};

// Datos históricos para evolución
const datosEvolucion = {
    fechas: [{% for analisis in analisis_historico %}"{{ analisis.fecha_analisis|date:'d/m' }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    carteraTotal: [{% for analisis in analisis_historico %}{{ analisis.cartera_total }}{% if not forloop.last %},{% endif %}{% endfor %}],
    carteraVencida: [{% for analisis in analisis_historico %}{{ analisis.cartera_vencida }}{% if not forloop.last %},{% endif %}{% endfor %}],
    pagosDelDia: [{% for analisis in analisis_historico %}{{ analisis.pagos_del_dia }}{% if not forloop.last %},{% endif %}{% endfor %}]
};

// Gráfico de Estados de Mora (Dona)
const ctxMora = document.getElementById('graficoEstadosMora').getContext('2d');
const graficoMora = new Chart(ctxMora, {
    type: 'doughnut',
    data: {
        labels: ['Al Día', 'Mora Temprana', 'Mora Alta', 'Mora Crítica'],
        datasets: [{
            data: [datosEstadosMora.alDia, datosEstadosMora.moraTemp, datosEstadosMora.moraAlta, datosEstadosMora.moraCritica],
            backgroundColor: [
                '#198754', // Verde (success)
                '#ffc107', // Amarillo (warning) 
                '#dc3545', // Rojo (danger)
                '#212529'  // Negro (dark)
            ],
            borderWidth: 2,
            borderColor: '#ffffff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
            legend: {
                display: false // Las etiquetas están debajo
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.raw || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                        return `${label}: ${value} créditos (${percentage}%)`;
                    }
                }
            }
        }
    }
});

// Gráfico de Evolución de Cartera (Líneas)
const ctxEvolucion = document.getElementById('graficoEvolucionCartera').getContext('2d');
const graficoEvolucion = new Chart(ctxEvolucion, {
    type: 'line',
    data: {
        labels: datosEvolucion.fechas,
        datasets: [
            {
                label: 'Cartera Total',
                data: datosEvolucion.carteraTotal,
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                fill: true,
                tension: 0.4
            },
            {
                label: 'Cartera Vencida',
                data: datosEvolucion.carteraVencida,
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                fill: false,
                tension: 0.4
            }
        ]
    },
    options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    callback: function(value) {
                        return '$' + value.toLocaleString();
                    }
                }
            }
        },
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': $' + context.raw.toLocaleString();
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}

{% endblock %}
